
# 📘 Magic Merge Excel 2.0 – 開発仕様書（Rust + egui）

---

## 🧭 概要

このアプリは、2～3つのExcelファイル（.xlsx）を読み込み、共通キーによる  
**外部 / 内部 / 左 / 右 / 縦結合** を実行し、即時プレビューと保存を可能にする  
**非プログラマ向けノーコードUI付き業務ツール**です。

---

## 🎯 目標

- ノーコード操作で結合・保存まで可能な業務ツール
- ユーザーが迷わないステップ形式ウィザード
- **軽量かつ高速**（Rust + polars + egui）
- **Jupyterライクな対話性・即時性**
- **保守性・可読性を最大限に高めた設計**
  - `if/else`のネストは最小限
  - UIパーツはすべてモジュール化
  - コンポーネントごとに責務分離

---

## 🧩 画面構成とステップ遷移

### 1. ホーム画面 `/`
- 「新しい結合プロジェクトを作成」ボタン → `/merge-wizard`

---

### 2. マージウィザード画面 `/merge-wizard`

#### 📁 ステップ 1：ファイル選択
- 最大3ファイル（.xlsx）
- A・B は必須、C はオプション（補完/消込等に利用）

**バリデーション**
- 2ファイル未満 → 次へ不可
- 列数が極端に異なる → エラー表示

---

#### 🔑 ステップ 2：結合キー設定
- 共通列の中から複数選択可（Checkbox + フィルタ）
- 例：勘定科目コード、取引先コードなど

**バリデーション**
- 共通列ゼロ → 警告
- 未選択 → 次へ不可

---

#### 🔗 ステップ 3：結合形式の選択
- ラジオボタン
  - 左結合（left join）
  - 右結合（right join）
  - 内部結合（inner join）
  - 外部結合（full outer join）
  - 縦結合（concat）

---

#### 📊 ステップ 4：列の選択と並び替え
- 左：全列一覧
- 右：出力対象列（ドラッグ＆ドロップで順序変更）
- 欠損列は灰色表示（結合により存在しない列）

**プレビュー**
- 上位5行＋下位5行を表示（ページネーション）

**バリデーション**
- 出力列ゼロ → エラー表示

---

#### 💾 ステップ 5：出力設定
- 自動生成ファイル名：  
  `A名称_B名称_YYYYMMDD.xlsx`
- 保存先：アプリ直下フォルダ or 任意パス指定
- 上書き確認あり

**バリデーション**
- `.xlsx` 形式のみ許可
- 重複ファイル名 → 警告表示

---

## 🧪 データ処理仕様

| 機能       | 使用ライブラリ             |
|------------|----------------------------|
| 結合       | polars (Rust)              |
| 出力       | umya-spreadsheet           |
| Excel読込  | calamine                   |

- 文字列：`"` などのトリム、null→空白
- 数値：自動変換（文字列でも可能な限り型推定）
- 欠損値：明示的に`N/A`、または空欄

---

## 🧠 アーキテクチャ設計指針

- UI要素はすべてコンポーネント化
  - `FileSelector`, `KeySelector`, `JoinTypePicker`, `ColumnSelector`, `PreviewTable`, `SavePanel`
- `if/else`のネストは1段までに抑え、早期リターンを使用
- `Preview`や`MergeEngine`など、状態をもつ処理は独立した構造体で管理
- すべての非同期処理はチャンネルで通知＋進捗バー表示

---

## 🖼️ UIブロック構成（レイアウト）



my_project/
├── .cursor-agent
├── spec.md
├── src/
│   ├── main.rs
│   ├── app.rs
│   └── components/
│       ├── file_selector.rs
│       ├── key_selector.rs
│       ├── join_type_picker.rs
│       ├── column_selector.rs
│       ├── preview_table.rs
│       └── save_panel.rs


追加
先に利用目的から結合種類を選ばせる設計」に変更する
つまり結合の目的からユーザーが自然に結合種類を選ぶ形にして、そのあとで適切なファイル選択
などUIを動的に変更する。場合によっては結合種類毎にコンポーネントを分けることも考慮
## 🔗 ステップ1：利用目的を選択（モードセレクト）

ラジオボタン形式：
- 前年対比（外部結合）
- 入金照合（2段階左結合）
- 完全一致検証（内部結合）
- 比較用結合（左または右結合）
- 縦連結（concat）→ この場合、3つ以上も可

選択内容に応じてステップ2以降の表示UI（ファイル数、結合キーUIなど）を動的に切り替える

📐 モード別ファイル選択UIの例
モード	ファイルスロット	目的
前年対比（外部結合）	A（当期）＋B（前期）	勘定科目＋取引先コードで結合し、金額列を比較
入金照合（2段階）	A（入金）＋B（履歴）＋C（売上）	フリガナ→顧客コード→売上照合の2段階照合
完全一致（inner）	A（請求）＋B（納品）	完全一致する行だけ残す
比較用結合（左結合）	A（売上）＋B（見積）	主にA側に重きを置いて比較
縦結合（concat）	A＋B＋C（オプション）	形式が同じ複数ファイルを縦に連結（明細・履歴）